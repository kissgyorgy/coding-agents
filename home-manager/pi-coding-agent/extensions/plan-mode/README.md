# Plan Mode Extension

Read-only exploration mode for safe code analysis.

## Features

- **Read-only tools**: Restricts available tools to `read`, `bash`, `grep`, `find`, `ls`, `questionnaire`
- **Bash filtering**: Destructive commands are blocked; only allowlisted read-only commands pass through
- **Plan extraction**: Extracts numbered steps from `# Todo items` or `Plan:` sections in agent output
- **Plan file generation**: Saves plans to `plans/plan-<date>-<slug>.md` with AI-generated slug and overview (via Claude Haiku)
- **Structured plan files**: Generated files include Overview, Implementation plan, Files to modify, and Todo items sections
- **File reference extraction**: Automatically extracts file paths mentioned in the plan into the "Files to modify" section
- **Progress tracking**: Widget above the editor shows step completion status with checkboxes
- **`[DONE:n]` markers**: Agent marks steps complete during execution; completion state is tracked in real-time
- **Interactive picker**: After plan creation, a TUI picker offers "Execute the plan" or "Continue planning"
- **Context management**: Execution mode starts with a clean context from the execute message onward; plan mode injections are filtered out otherwise
- **Session persistence**: Full state (mode, todos, plan file path) survives session resume via `appendEntry`
- **Resume re-scan**: On session resume, re-scans messages after the last execution marker to rebuild completion state

## Commands & Shortcuts

| Trigger | Description |
|---------|-------------|
| `/plan` | Toggle plan mode (read-only exploration) |
| `/plan:execute` | Execute the current plan |
| `/plan:edit` | Edit the current plan file (inline editor) |
| `/plan:view` | View the current plan in a read-only scrollable modal |
| `/plan:model` | Configure models for slug generation and execution |
| `/todos` | Show current plan progress |
| `Ctrl+Alt+P` | Toggle plan mode |
| `Ctrl+Alt+E` | Execute the current plan |
| `Ctrl+Alt+O` | View the current plan in the read-only modal |
| `Ctrl+G` | Edit plan file in `$VISUAL`/`$EDITOR` (in plan/execution mode) |
| `--plan` flag | Start pi in plan mode |

## Usage

1. Enable plan mode with `/plan`, `Ctrl+Alt+P`, or `--plan` flag
2. Ask the agent to analyze code and create a plan
3. The agent outputs a structured plan:

```markdown
# Overview
Brief summary of the plan.

# Implementation plan
Detailed analysis and approach.

# Files to modify
- path/to/file1.ts
- path/to/file2.ts

# Todo items
1. First step description
2. Second step description
3. Third step description
```

4. Start execution in one of three ways:
   - Choose "Execute the plan" from the interactive picker
   - Run `/plan:execute`
   - Press `Ctrl+Alt+E`
5. Edit the plan anytime:
   - `Ctrl+G` opens the plan file in `$VISUAL`/`$EDITOR` (creates from template if no plan exists)
   - `/plan:edit` opens the inline editor
6. View the plan anytime:
   - `/plan:view` or `Ctrl+Alt+O` opens a read-only Markdown viewer modal
   - Scroll with `â†‘/â†“`, `PageUp/PageDown`, `Home/End`; close with `Esc`
   - Works even outside plan/execution mode as long as a plan file exists
7. During execution, the agent marks steps complete with `[DONE:n]` tags
8. Progress widget shows completion status; footer shows `ðŸ“‹ completed/total`
9. On completion, all tools are restored and state is cleared

> **Note:** `Ctrl+G` is overridden in plan/execution mode to edit the plan file
> instead of the prompt. Outside plan mode, `Ctrl+G` works normally (opens
> prompt in external editor).

## How It Works

### Plan Mode (Read-Only)
- Only read-only tools available (`read`, `bash`, `grep`, `find`, `ls`, `questionnaire`)
- Bash commands must match the safe allowlist AND not match any destructive pattern
- Agent receives a context injection with plan mode instructions and output format
- Agent creates a plan without making changes

### Execution Mode
- Full tool access restored (`read`, `bash`, `edit`, `write`)
- Context is trimmed: only messages from the execution marker onward are kept
- The plan file content and todo list are sent as a user message to start execution
- Agent executes steps in order, marking each with `[DONE:n]`
- Widget shows progress; on full completion, mode resets automatically

### Plan File
- Saved to `plans/plan-<date>-<slug>.md`
- Slug and overview are generated by Claude Haiku from the plan content
- Falls back to `plan-<date>.md` if slug generation fails
- Template for new plans (via `Ctrl+G` or `/plan:edit`):
  ```markdown
  # Overview

  # Implementation plan

  # Files to modify

  # Todo items
  1.
  ```

### Model Settings

Configurable via `/plan:model` command. Settings are persisted in `~/.pi/agent/plan-mode.json`.

```json
{
  "slugModel": { "provider": "anthropic", "id": "claude-haiku-4-5" },
  "executionModel": { "provider": "anthropic", "id": "claude-sonnet-4-5" }
}
```

**Slug/Overview model** (`slugModel`): Used for generating the plan file slug and overview summary. This is a quick, cheap API call. Defaults to `anthropic/claude-haiku-4-5` if not configured.

**Execution model** (`executionModel`): The model switched to via `pi.setModel()` when entering execution mode. When not configured, the current model is kept (no switch). The previous model is automatically restored when the plan completes.

### Command Allowlist

Safe commands (allowed):
- File inspection: `cat`, `head`, `tail`, `less`, `more`, `bat`
- Search: `grep`, `find`, `rg`, `fd`
- Text processing: `wc`, `sort`, `uniq`, `diff`, `sed -n`, `awk`, `jq`
- Directory: `ls`, `pwd`, `tree`, `exa`
- File info: `file`, `stat`, `du`, `df`, `which`, `whereis`, `type`
- Output: `echo`, `printf`
- Environment: `env`, `printenv`
- Git read: `git status`, `git log`, `git diff`, `git show`, `git branch`, `git remote`, `git config --get`, `git ls-*`
- Package info: `npm list/ls/view/info/search/outdated/audit`, `yarn list/info/why/audit`
- Version checks: `node --version`, `python --version`
- Network (read): `curl`, `wget -O -`
- System info: `uname`, `whoami`, `id`, `date`, `cal`, `uptime`, `ps`, `top`, `htop`, `free`

Blocked commands:
- File modification: `rm`, `rmdir`, `mv`, `cp`, `mkdir`, `touch`, `chmod`, `chown`, `chgrp`, `ln`, `tee`, `truncate`, `dd`, `shred`
- Redirects: `>`, `>>`
- Git write: `git add`, `git commit`, `git push`, `git pull`, `git merge`, `git rebase`, `git reset`, `git checkout`, `git branch -d/-D`, `git stash`, `git cherry-pick`, `git revert`, `git tag`, `git init`, `git clone`
- Package install: `npm install/uninstall/update/ci/link/publish`, `yarn add/remove/install/publish`, `pnpm add/remove/install/publish`, `pip install/uninstall`
- System packages: `apt/apt-get install/remove/purge/update/upgrade`, `brew install/uninstall/upgrade`
- System control: `sudo`, `su`, `kill`, `pkill`, `killall`, `reboot`, `shutdown`, `systemctl start/stop/restart/enable/disable`, `service start/stop/restart`
- Editors: `vi`, `vim`, `nano`, `emacs`, `code`, `subl`
